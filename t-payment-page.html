<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-address/t-address.html">
<link rel="import" href="../t-creditcard/t-creditcard.html">
<link rel="import" href="../t-checkbox/t-checkbox.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-section-header/t-section-header.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="t-car-book-api.html"/>
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<link rel="import" href="../t-loader/t-fullpage-loader.html">

<dom-module id="t-payment-page">
    <template>
        <style include="iron-flex"></style>
        <style include="travel-element-styles">
          :host, t-button {
            display: block;
            font-family: var(--header-font-family, --primary-font-family);
            font-size: var(--font-14, 14px);
          }
        .payable {
            font-size: var(--font-18, 18px);
        }
        </style>

        <content select="t-header"></content>

        <t-notify id="notify"></t-notify>

        <t-section-header
            id="paymentHeader"
            class="margin-bottom"
            label="Trip Summary">              
        </t-section-header>
        
        <t-car-itinerary-details
            id="itineraryDetails"
            is-collapsible
            itinerary="[[itinerary]]"
            search-criteria=[[searchCriteria]]>
        </t-car-itinerary-details>

        <t-faredetails 
          id="fareDetails"
          is-collapsible
          itinerary-fare-label="Car Rental">
        </t-faredetails>

        <template is="dom-if" if="[[itinerary.isPostPaid]]">
            <div class="layout horizontal section-small payable">
                <span class="secondary-text">Due at pick-up</span>
                <span class="flex"></span>
                <span>{{_getPayableAmount()}}</span>
            </div>
            <t-section-header
                class="margin-bottom"
                id="paymentHeader"
                label="Confirm Your Booking">              
            </t-section-header>
        </template>

        <template is="dom-if" if="[[_showFullPageLoader]]">
            <t-fullpage-loader active>
                <div hidden="[[_processingMsg]]">
                    Please do not refresh the page, we are confirming your booking...
                </div> 
                <div hidden="[[_longProcessingMsg]]">
                    Please wait, this is taking longer than expected...
                </div>     
            </t-fullpage-loader>
        </template>

        <template is="dom-if" if="[[!itinerary.isPostPaid]]">
            <t-section-header
                class="margin-bottom"
                id="paymentHeader"
                label="Payment Information">              
            </t-section-header>

            <t-creditcard 
                id="creditCard">
            </t-creditcard>

            <t-address 
                id="address"
                prevent-auto-populate
                country-api="[[apiBaseUrl]]api/content/countries"
                base-geo-api="[[apiBaseUrl]]api/content"
                query-params="?token=[[authToken]]">
            </t-address>
        </template>

        <div class="layout horizontal start section-small">
            <t-checkbox id="acceptance" checked="{{checked}}"><div hidden>something</div></t-checkbox>
            <div class="flex font-12 secondary-text">
                I have read and accept the <a class="link-style" on-click="showPolicies">Booking Policies</a>, <a href="http://www.bluegreenvacations.com/terms-of-use" class="link-style" target="_blank">Terms & Conditions</a> and <a href="http://www.bluegreenvacations.com/privacy-policy" class="link-style" target="_blank">Privacy Policy</a>.
            </div>
        </div>

        <div class="layout horizontal section-small">
            <t-button 
                label="Pay now" 
                id="submit" 
                class="primary flex" 
                disabled="{{!checked}}" 
                on-click="bookNow">              
            </t-button>
        </div>

        <t-car-book-api
            id="bookApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" 
            api-relative-url="api/ShoppingCart/book" 
            auth-token="{{authToken}}"
            on-t-car-book-api-success="_onBookSuccess"
            on-t-car-book-api-error="_onBookError">
        </t-car-book-api>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Booked_Itinerary"
            api-url-format="{{apiUrlFormat}}"
            on-t-sessionstorage-save-success="_onSessionSave">
        </t-sessionstorage>
    </template>

    <script>
      Polymer({

        is: 't-payment-page',

        observers:[
            '_onItineraryUpdate(visible, itinerary, passengerInfo, searchCriteria)'
        ],

        behaviors: [
            TravelNxt.Behaviors.DateBehavior
        ],

        behaviors: [
            TravelNxt.Behaviors.DateBehavior
        ],

        properties: {

            visible: {
              type: Boolean,
              value: false,
              notify: true
            },

            /*
             * <p>This string is query string containing token value</p>
            */
            authToken: {
                type: String,
                value: ''
            },

            /*
             * <p>This property holds the value of api base URL</p>
            */
            apiBaseUrl: {
                type: String,
                value: ''
            },

            /*
             * <p>This property holds the value of web api URL format</p>
            */
            apiUrlFormat: {
                type: String,
                value: ''
            },

            /*
             * <p>This property holds the value of web api URL format</p>
            */
            _processingMsg: {
                type: Boolean,
                value: false
            },

            /*
             * <p>This property holds the value of web api URL format</p>
            */
            _longProcessingMsg: {
                type: Boolean,
                value: true
            },

            /*
             * <p>This property holds the value of web api URL format</p>
            */
            _showFullPageLoader: {
                type: Boolean,
                value: false
            },

            /*
             * <p>This property holds the value of web api URL format</p>
            */
            itinerary: {
                type: Object
            },

            passengerInfo: {
                type: Object
            },

            searchCriteria: {
              type: Object
            }
        },

        bookNow: function () {

            this._bindTimer();

            this.$.notify.active = false;

            if (this.validate()) {
                this._showFullPageLoader = true;
                var data = this._getBookingData();
                this.$.bookApi.book(data);
            }
        },

        validate: function () {
            if (this.$.submit.disabled) {
              return false;
            }
            if (this.itinerary.isPostPaid) {
              return true;
            }
            var isValid = true;
            isValid = this.$$('#address').validate() && isValid;
            return this.$$('#creditCard').validate() && isValid;
        },

        _onBookSuccess: function (e) {
            this._showFullPageLoader = false;
            
            if (!e.detail) {
              return;
            }

            this.$.sessionStore.value = this._translateItinerary(e.detail);
            this.$.sessionStore.save();
        },

        _onBookError: function (e) {
            this._showFullPageLoader = false;
            this.$.notify.active = true;
            this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
            this.fire('book-error');
        },

        _onSessionSave: function () {
            this.fire('book-success', this.$.sessionStore.value);
        },

        _onItineraryUpdate: function (visible, itinerary, passengerInfo, searchCriteria) {
            if (!itinerary || !passengerInfo || !searchCriteria || !visible) {
                return;
            }

            this.$.acceptance.checked = false;
            this.$.notify.active = false;
            if(!this.itinerary.isPostPaid){
                this.$$('#address').pullCountryList();
            }
            this.$.itineraryDetails.setDetails(itinerary, searchCriteria);
            this._setFareDetails();
        },

        _getBookingData: function () {

            return {
                itinerary: this.itinerary,
                passengerInfo: this.passengerInfo,
                payment: this._getCreditCardInfo()
            }        
        },

        _getCreditCardInfo: function () {
          var address = this.$$('#address').getAddress();
          var payment = this.$$('#creditCard').getInfo();
          payment.billingAddress = address;

          return payment;
        },

        _translateItinerary: function (bookedItinerary) {

            bookedItinerary.inventoriesInfo[0].searchCriteria.pickupTime = bookedItinerary.inventoriesInfo[0].searchCriteria.pickupDate.time;
            bookedItinerary.inventoriesInfo[0].searchCriteria.pickupDate = bookedItinerary.inventoriesInfo[0].searchCriteria.pickupDate.date;

            bookedItinerary.inventoriesInfo[0].searchCriteria.dropoffTime = bookedItinerary.inventoriesInfo[0].searchCriteria.dropoffDate.time;
            bookedItinerary.inventoriesInfo[0].searchCriteria.dropoffDate = bookedItinerary.inventoriesInfo[0].searchCriteria.dropoffDate.date;

            return {                            
                confirmationNumber: bookedItinerary.confirmationNumber,
                bookingStatus: bookedItinerary.bookingStatus,
                name: bookedItinerary.name,
                itinerary: bookedItinerary.inventoriesInfo[0].inventory,
                searchCriteria: bookedItinerary.inventoriesInfo[0].searchCriteria,
                passengers: bookedItinerary.passengers
            };
        },

        _getPayableAmount: function () {
            if (!this.itinerary || !this.itinerary.fare) {
                return '';
            }

            var totalFare = this.itinerary.fare.components.find(function(item){
                return item.type.toLowerCase() === 'totalfare';
            });

            if (!totalFare) {
                return '';
            }

            return totalFare.money.currency + ' ' + totalFare.money.amount;
        },

        _setFareDetails: function () {
            if (!this.itinerary || !this.searchCriteria) {
                return;
            }

            var formattedDate = this._getDateComponents(this.searchCriteria.pickupDate);
            this.pickupDate = formattedDate.date + ' ' + formattedDate.shortMonth + ' ' + this.searchCriteria.pickupTime;

            formattedDate = this._getDateComponents(this.searchCriteria.dropoffDate);
            this.dropoffDate = formattedDate.date + ' ' + formattedDate.shortMonth + ' ' + this.searchCriteria.dropoffTime;

            this.$.fareDetails.baseFareLabel = 'Avg. per day rate x ' + this._dateDiff(this.pickupDate, this.dropoffDate);

            if (this.itinerary.fare && this.itinerary.fare.components) {
                this.$.fareDetails.data = this.itinerary.fare.components;
            }
        },

        _bindTimer: function () {

            _timer = setTimeout(function () {
                this._processingMsg = true;
                this._longProcessingMsg = false;
            }.bind(this), parseInt(Eva.paymentProcessingInterval));
        }
      });
    </script>
</dom-module>
