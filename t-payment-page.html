<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../t-address/t-address.html">
<link rel="import" href="../t-creditcard/t-creditcard.html">
<link rel="import" href="../t-checkbox/t-checkbox.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-section-header/t-section-header.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="t-car-book-api.html"/>
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">

<dom-module id="t-payment-page">
  <template>
    <style include="iron-flex-layout-classes"></style>
    <style include="travel-element-styles">
      :host, t-button {
        display: block;
      }
    </style>

    <content select="t-header"></content>

    <t-notify id="notify"></t-notify>
    
    <t-car-itinerary-details
        id="itineraryDetails"
        is-collapsible
        itinerary="[[itinerary]]"
        search-criteria=[[searchCriteria]]>
    </t-car-itinerary-details>

    <t-section-header
        id="paymentHeader"
        hidden$="[[itinerary.isPostPaid]]"
        label="Payment Information">              
    </t-section-header>

    <t-section-header
        id="paymentHeader"
        hidden$="[[!itinerary.isPostPaid]]"
        label="Confirm Your Booking">              
    </t-section-header>

    <t-creditcard 
        id="creditCard"
        hidden$="[[itinerary.isPostPaid]]">
    </t-creditcard>

    <t-address 
        id="address"
        country-api="[[apiBaseUrl]]api/content/countries"
        base-geo-api="[[apiBaseUrl]]api/content"
        hidden$="[[itinerary.isPostPaid]]"
        query-params="?token=[[authToken]]">
    </t-address>

    <div class="layout horizontal start section-small">
        <t-checkbox id="acceptance" checked="{{checked}}"><div hidden>something</div></t-checkbox>
        <div class="flex font-12 secondary-text">
            I have read and accept the <a class="link-style" on-click="showPolicies">Booking Policies</a>, <a href="http://www.bluegreenvacations.com/terms-of-use" class="link-style" target="_blank">Terms & Conditions</a> and <a href="http://www.bluegreenvacations.com/privacy-policy" class="link-style" target="_blank">Privacy Policy</a>.
        </div>
    </div>

    <div class="layout horizontal section-small">
        <t-button 
            label="Pay now" 
            id="submit" 
            class="primary flex" 
            disabled="{{!checked}}" 
            on-click="bookNow">              
        </t-button>
    </div>

    <t-car-book-api
        id="bookApi" 
        loading={{loading}} 
        api-base-url="{{apiBaseUrl}}" 
        api-relative-url="api/ShoppingCart/book" 
        auth-token="{{authToken}}"
        on-t-car-book-api-success="onBookSuccess"
        on-t-car-book-api-error="onBookError">
    </t-car-book-api>

    <t-sessionstorage
        id="sessionStore"
        key="Car_Booked_Itinerary"
        api-url-format="{{apiUrlFormat}}"
        on-t-sessionstorage-save-success="onSessionSave"
        on-t-sessionstorage-load-success="onSessionLoad">
    </t-sessionstorage>

  </template>

  <script>
    Polymer({

      is: 't-payment-page',

      observers:[
          '_onItineraryUpdate(visible)'
      ],

      properties: {

          visible: {
            type: Boolean,
            value: false,
            notify: true
          },

          /*
           * <p>This string is query string containing token value</p>
          */
          authToken: {
              type: String,
              value: ''
          },

          /*
           * <p>This property holds the value of api base URL</p>
          */
          apiBaseUrl: {
              type: String,
              value: ''
          },

          /*
           * <p>This property holds the value of web api URL format</p>
          */
          apiUrlFormat: {
              type: String,
              value: ''
          },

          /*
           * <p>This property holds the value of web api URL format</p>
          */
          itinerary: {
              type: Object
          },

          passengerInfo: {
              type: Object
          },

          searchCriteria: {
            type: Object
          }
      },

      bookNow: function () {
          if (this.validate()) {
            var data = this._getBookingData();
            this.$.bookApi.book(data);
          }
      },

      validate: function () {
          if (this.$.submit.disabled) {
            return false;
          }
          if (this.itinerary.isPostPaid) {
            return true;
          }
          var isValid = true;
          isValid = this.$.address.validate() && isValid;
          return this.$.creditCard.validate() && isValid;
      },

      onBookSuccess: function (e) {
          
          if (!e.detail) {
            return;
          }

          this.$.sessionStore.value = e.detail;
          this.$.sessionStore.save();
      },

      onBookError: function (e) {
          this.$.notify.active = true;
          this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
          this.fire('book-error');
      },

      onSessionSave: function () {
          this.fire('book-success', this.$.sessionStore.value);
      },

      _onItineraryUpdate: function (visible) {
          if (this.itinerary && this.passengerInfo && visible) {
              this.$.notify.active = false;
              this.$.address.pullCountryList();
              this.$.itineraryDetails.setDetails();
          }
      },

      _getBookingData: function () {

          return {
              itinerary: this.itinerary,
              passengerInfo: this.passengerInfo,
              payment: this._getCreditCardInfo()
          }        
      },

      _getCreditCardInfo: function () {
        var address = this.$.address.getAddress();
        var payment = this.$.creditCard.getInfo();
        payment.billingAddress = address;

        return payment;
      }

    });
  </script>
</dom-module>
